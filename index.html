<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Скачать приложение</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f172a;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      text-align: center;
      max-width: 420px;
      width: 100%;
      padding: 24px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
    }
    h1 { margin: 0 0 8px 0; font-size: 20px; }
    #status { opacity: 0.9; margin-bottom: 16px; }
    .buttons {
      display: none;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }
    a.button, button#manualBtn {
      display: block;
      padding: 12px;
      border-radius: 10px;
      background: #2563eb;
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background 0.15s;
      text-align: center;
    }
    a.button:hover, button#manualBtn:hover { background:#1d4ed8; }
    .manual-wrap { margin-top: 18px; }
    .small { opacity: 0.8; font-size: 13px; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Скачать приложение</h1>
    <p id="status">Определяем ваше устройство… (<span id="count">3</span>)</p>

    <div class="buttons" id="fallback">
      <a class="button" id="btn-ios" href="https://apps.apple.com/ru/app/v2raytun/id6476628951">Скачать для iOS</a>
      <a class="button" id="btn-android" href="https://play.google.com/store/apps/details?id=com.v2raytun.android">Скачать для Android</a>
      <a class="button" id="btn-windows" href="https://storage.v2raytun.com/v2RayTun_Setup.exe">Скачать для Windows</a>
      <a class="button" id="btn-mac" href="https://apps.apple.com/en/app/v2raytun/id6476628951">Скачать для Mac</a>
    </div>

    <div class="manual-wrap">
      <button id="manualBtn">Скачать вручную</button>
      <div class="small">Если автоматическое перенаправление не сработает — нажмите «Скачать вручную».</div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ЗАМЕНИТЬ ссылки тут при необходимости:
  const links = {
    ios: "https://apps.apple.com/ru/app/v2raytun/id6476628951",
    android: "https://play.google.com/store/apps/details?id=com.v2raytun.android",
    windows: "https://storage.v2raytun.com/v2RayTun_Setup.exe",
    mac: "https://apps.apple.com/en/app/v2raytun/id6476628951"
  };

  const statusEl = document.getElementById('status');
  const countEl = document.getElementById('count');
  const fallbackEl = document.getElementById('fallback');
  const manualBtn = document.getElementById('manualBtn');

  let countdown = 3;
  let autoRedirectTimer = null;
  let countdownInterval = null;
  let autoRedirectCancelled = false;

  function isValidLink(url) {
    return typeof url === 'string' && url.length > 4 && !/LINK/.test(url);
  }

  // Надёжная детекция iPadOS + iPhone/Android/Windows/macOS
  function detectPlatform() {
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    // iPadOS detection: может показывать Macintosh, но иметь сенсорные точки
    if ((/iPad|iPhone|iPod/.test(ua) && !window.MSStream) ||
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) {
      return 'ios';
    }
    if (/Android/.test(ua)) return 'android';
    if (/Windows NT/.test(ua)) return 'windows';
    if (/Macintosh/.test(ua)) return 'mac';
    return 'unknown';
  }

  function showFallback(reason) {
    statusEl.textContent = reason || "Не удалось определить устройство. Выберите вручную:";
    fallbackEl.style.display = 'flex';
  }

  function doRedirect() {
    if (autoRedirectCancelled) return;
    const platform = detectPlatform();
    const target = links[platform];

    if (platform === 'unknown') {
      showFallback("Не удалось определить устройство. Выберите вручную:");
      return;
    }

    if (!isValidLink(target)) {
      // если ссылка не задана или заглушка — показать fallback
      showFallback("Ссылка для этого устройства не указана. Выберите вручную:");
      return;
    }

    // Перед редиректом обновим статус на несколько мгновений (пользователь увидит)
    statusEl.textContent = "Перенаправляем...";
    // Попробуем перенаправить
    try {
      window.location.replace(target);
    } catch (e) {
      // в редких случаях replace может упасть в некоторых webview — покажем fallback
      showFallback("Перенаправление заблокировано. Выберите вручную:");
    }
  }

  function startCountdown() {
    countEl.textContent = countdown;
    countdownInterval = setInterval(() => {
      countdown--;
      countEl.textContent = countdown;
      if (countdown <= 0) {
        clearInterval(countdownInterval);
      }
    }, 1000);

    // Запускаем автопереход через 3 секунды
    autoRedirectTimer = setTimeout(() => {
      doRedirect();
    }, 3000);
  }

  // Если пользователь запросил "Скачать вручную" — отменяем автопереход и показываем кнопки
  manualBtn.addEventListener('click', () => {
    autoRedirectCancelled = true;
    if (autoRedirectTimer) clearTimeout(autoRedirectTimer);
    if (countdownInterval) clearInterval(countdownInterval);
    showFallback("Выберите вручную:");
  });

  // Небольшая проверка: если при загрузке уже неизвестная платформа или ссылки явно пустые - покажем fallback сразу
  const platform = detectPlatform();
  if (platform === 'unknown' ||
      !isValidLink(links[platform])) {
    // показываем fallback, но всё равно даём пользователю возможность авто-редиректа (по желанию)
    showFallback();
    // не запускаем авто-редирект в этом случае; если хочешь всё-таки пытаться — раскомментируй startCountdown();
  } else {
    startCountdown();
  }

  // Дополнительно: если хочешь, можно скрыть manualBtn на iOS/Android, но я оставил его доступным всегда.
});
</script>
</body>
</html>
